name: Promote Dev Digest to Stage

on:
  workflow_run:
    workflows: [ "Build & Update Dev" ]
    types: [ completed ]

permissions:
  contents: write
  pull-requests: write

jobs:
  promote-stage:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read digest from dev values.yaml
        working-directory: py-api
        id: read-dev-digest
        run: |
          DIGEST=$(grep -E 'digest:' envs/dev/values.yaml | head -n1 | sed -E 's/.*"(.*)".*/\1/')
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

      - name: Make set-digest executable
        working-directory: py-api
        run: chmod +x scripts/set-digest.sh

      - name: Update stage values with digest
        working-directory: py-api
        run: |
          ./scripts/set-digest.sh envs/stage/values.yaml "${{ steps.read-dev-digest.outputs.digest }}"

      - name: Create promotion PR to stage
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Promote digest ${{ steps.read-dev-digest.outputs.digest }} to stage"
          branch: "promote-stage/${{ steps.read-dev-digest.outputs.digest }}"
          title: "Promote ${{ steps.read-dev-digest.outputs.digest }} â†’ stage"
          body: |
            This PR promotes image digest **${{ steps.read-dev-digest.outputs.digest }}** from dev to stage.
          add-paths: |
            py-api/envs/stage/values.yaml